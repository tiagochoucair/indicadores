<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/main.css"/>
    <link rel="stylesheet" href="css/bootstrap-select.min.css"/>
    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>

    <title></title>
</head>
<body data-ano="2015" data-mes="1" data-url="IndicesAnalista" data-analista="1">

    <div class="container">
        <div class="jumbotron">
            <img class="img-rounded" id="img" src="http://www.choucairtesting.com/assets/Uploads/logochoucair.png" alt="" width="262" height="66" >
        </div>

    <button type="button" id="btnModal" class="btn btn-info btn-xs"style="float:right;">
        <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>
    </button>
        <div class="row">
            <H3>FILTROS</H3>
            <div class="panel panel-default">
                <div class="panel-body">
                    <div id="dashboard_div" style="height: 20px;"></div>  
                </div>
            </div>
        </div>
        <select  class="selectpicker span2" title='Seleccione El Servicio' data-width="280px"
        id="ServicioSelect" data-style="btn-inverse">
        <option label="IndicesAnalista" value="IndicesAnalista">Panorama De Reportes Por Analista</option>
        <option label="IndicesClientes" value="IndicesClientes">Panorama De Reportes Por Cliente</option>
        <option label="HorasPorAnalista" value="HorasPorAnalista">Acompañamiento De Reporte Diario</option>
        <option label="HorasPorCargoPorCiudad" value="HorasCargoCiudad">Reporte de Horas Por Servicio Por Cargo</option>
        <option label="FaltaTarifames" value="FaltaTarifaMes">Reporte De Tarifas </option>
        <option label="ReporteMaxTime" value="ReporteMaxTime">Reporte De MaxTime </option>
        <option label="ReporteUltimaFecha" value="ReporteUltimaFecha">Reporte Ultima Fecha </option>
    </select>
    <select class="selectpicker span2" style="float: left;"  data-width="140px"
    title='Seleccione El Año' id="anoSelect" data-style="btn-inverse">
    <option value="0">Seleccione Uno</option>
    <option value="2015">2015</option>
    <option value="2014">2014</option>
    <option value="2013">2013</option>
    <option value="2012">2012</option>
</select>

<select class="selectpicker span2" style="float: left;" title='Seleccione El Mese' data-width="140px"
id="mesSelect" data-style="btn-inverse;">
<option value="0">Seleccione Uno</option>
<option value="1">Enero</option>
<option value="2">Febrero</option>
<option value="3">Marzo</option>
<option value="4">Abril</option>
<option value="5">Mayo</option>
<option value="6">Junio</option>
<option value="7">Julio</option>
<option value="8">Agosto</option>
<option value="9">Septiembre</option>
<option value="10">Octube</option>
<option value="11">Noviembre</option>
<option value="12">Diciembre</option>
</select>

<select name="AnalistaSelect" data-live-search="true" title='Seleccione El Analista' data-width="330px"
data-hide-disabled: true  class="selectpicker span4" id="AnalistaSelect" data-style="btn-inverse;">
</select>     

</div>


<div id="myModal" class="modal fade">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Decripción de Campos</h4>
            </div>
            <div class="col-md-6">
                <b style="font-size: medium">IF</b>
                <b>=</b>
                Horas Facturables / Horas Laborales
            </div>
            <div class="col-md-6">       
                <b style="font-size: medium">IOP</b>
                <b>=</b>
                (Horas Facturables - Horas Adicionales) /Horas Laborales
            </div>        
            <div class="col-md-6">            
                <b style="font-size: medium">IE</b>
                <b>=</b>
                Horas Facturables / (Horas Laborales - (Incapacidades+Vacaciones))
            </div>        
            <div class="col-md-6">             
                <b style="font-size: medium">Incap</b>
                <b>=</b>
                Incapacidades
            </div>        
            <div class="col-md-6">         
                <b style="font-size: medium">Vac</b>
                <b>=</b>
                Vacaciones
            </div>        
            <div class="col-md-6"> 
                <b style="font-size: medium">Comp</b>
                <b>=</b>
                Compesantorias
            </div>        
            <div class="col-md-6"> 
                <b style="font-size: medium">HANF</b>
                <b>=</b>
                Horas Adicionales No Facturables
            </div>        
            <div class="col-md-6"> 
                <b style="font-size: medium">HAF</b>
                <b>=</b>
                Horas Adicionales Facturables
            </div>        
            <div class="col-md-6">       
                <b style="font-size: medium">HASC</b>
                <b>=</b>
                Horas Adicionales Solicitadas por el Cliente
            </div>        
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<input type="button" class="btn btn-default" id="btnExport" value=" Exportar a Excel " style="display:none;" />

<div id="charts">

</div>

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="lib/all.min.js"></script>
<script type="text/javascript">
    function searchToObject(urlSearch) {
        var pairs = urlSearch.substring(1).split("&"),
        obj = {},
        pair,
        i;
        for ( i in pairs ) {
            if ( pairs[i] === "" ) continue;

            pair = pairs[i].split("=");
            obj[ decodeURIComponent( pair[0] ) ] = decodeURIComponent( pair[1] );
        }

        return obj;
    }
    // Load the Visualization API and the piechart package.
    google.load('visualization', '1', {'packages':['corechart','controls','table', 'calendar']});
    // Set a callback to run when the Google Visualization API is loaded.
    //google.setOnLoadCallback(drawChart);

    $("#mesSelect").on("change", function(e){
        $.data(document.body, "mes", this.value);
        onChange();
    });

    $("#anoSelect").on("change", function(e){
        $.data(document.body, "ano", this.value);
        onChange();
    });

    $("#ServicioSelect").on("change", function(e){
        $.data(document.body, "url", this.value);
        onChange();
    });

    $("#AnalistaSelect").on("change", function(e){
        $.data(document.body, "analista", this.value);
        onChange();
    });

    $("#filtroCiudad_div").click(function() {
        $("#dashboard_div").setAttribute(height= height+1);
    });

    function overlay() {
        el = document.getElementById("overlay");
        el.style.visibility = (el.style.visibility == "visible") ? "hidden" : "visible";
    }

    $('#btnExport').click(function(){
        var data = {
            ano: $.data(document.body, "ano"),
            mes: $.data(document.body, "mes")
        };
        window.open(config.apiEndpoint + 'DownloadReport?'+$.param(data));
    });

    function onChange(){
        // actualizar el ano y mes
        var data = {
            ano: $.data(document.body, "ano"),
            mes: $.data(document.body, "mes"),
            url: $.data(document.body, "url"),
            analista:$.data(document.body, "analista")
        };
        window.location.hash = "#?"+$.param(data);
        window.location.reload();
    }

    //fill the dynamically the analysts <select>
    var $select = $('#AnalistaSelect');
    $.getJSON(config.apiEndpoint + 'IdNombreAnalista', function(data){
        $select.append('<option value="' + '0' + '">' + "Selecctione Uno" + '</option>');
        $.each(data, function(key, val){
            $select.append('<option value="' + val.Id + '">' + val.Nombre + '</option>');
        })
    });

    function convertToDate(data){
        var dateIndexes = [];
        data['cols'].forEach(function(col, i){
            var index = 0;
            if (col.type === 'date') index = 1;
            dateIndexes.push(index);
        });
        data['rows'].forEach(function(row, indexRow){
            row['c'].forEach(function(value, indexValue){
                if (dateIndexes[indexValue] === 1){
                    var dateSlices = value['v'].substr(0,10).split("-");
                    data['rows'][indexRow]['c'][indexValue]['v'] =
                    new Date(parseInt(dateSlices[0]),
                        parseInt(dateSlices[1])-1,
                        parseInt(dateSlices[2]));
                }
            });
        });
        return data;
    }

    function drawChart(e, ano, mes, url, analista) {
        var ano = ano;
        var mes = mes;
        var urls = url;
        var analista = analista || 0;
        var jsonData = $.ajax({
            url: config.apiEndpoint + urls,
            dataType:"json",
            data: {"ano": ano, "mes": mes, "analista": analista}
        }).then(function(data, textStatus){
            changeService(urls);
            draw(convertToDate(data));
        }, function(xhr, textStatus){
            console.log("ERROR 123");
        });
    }


    $(document).ready(function(){
        var searchObj = searchToObject(window.location.hash.substring(1));
        changeService(searchObj.url);
        $("#mesSelect").val(searchObj.mes);
        $.data(document.body, "mes", searchObj.mes);
        $("#anoSelect").val(searchObj.ano);
        $.data(document.body, "ano", searchObj.ano);
        $("#ServicioSelect").val(searchObj.url);
        $.data(document.body, "url", searchObj.url);
        $("#AnalistaSelect").val(searchObj.analista);
        $.data(document.body, "analista", searchObj.analista);
        drawChart(null, searchObj.ano, searchObj.mes, searchObj.url, parseInt(searchObj.analista));

        $("#btnModal").click(function(){
            $("#myModal").modal('show');
        });

    });

    function changeService(service){
        document.getElementById("serviceScript")
        .setAttribute("src","./assets/js/"+service+".js")
    }


</script>
<script id="serviceScript"></script>
</body>
</html>